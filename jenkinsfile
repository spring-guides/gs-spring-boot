
pipeline {
    agent any

    environment {
        USER = 'petclinicapp'
        GROUP = 'petclinicapp'
        S3_BUCKET = 'petclinicapp'
        BUILD_FILE_NAME = 'petclinicapp-v1.jar'
        LOCAL_FILE_PATH = "/home/${USER}/${BUILD_FILE_NAME}"
        KEY_FILE = "/home/jenkins/petclinicappkey.pem"
    }

    stages {
        stage('Build') {
            steps {
                script {
                    sh '''
                        cd initial
                        ./mvnw clean package
                    '''
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    sh '''
                        # Upload artifact to S3
                        aws s3 cp $WORKSPACE/initial/target/$BUILD_FILE_NAME s3://$S3_BUCKET

                        # Fetch EC2 instance IPs
                        output=$(aws ec2 describe-instances \
                            --filters "Name=tag:appname,Values=petclinic" "Name=instance-state-name,Values=running" \
                            --query "Reservations[*].Instances[*].[InstanceId,PublicIpAddress]" \
                            --output json)
                        ips=$(echo "$output" | jq -r '.[][][1]')
                        echo "EC2 IPs: $ips"

                        # Deploy artifact on each instance
                        for ip in $ips; do
                            echo "-----------------------------------------------------"
                            echo "Deploying to $ip"
                            ssh -o StrictHostKeyChecking=no -i $KEY_FILE ubuntu@$ip << EOF
                                sudo aws s3 cp s3://$S3_BUCKET/$BUILD_FILE_NAME $LOCAL_FILE_PATH
                                sudo systemctl restart petclinicapp.service
                                echo "Deployment completed on $ip"
                            EOF
                            echo "-----------------------------------------------------"
                        done
                    '''
                }
            }
        }
    }
}
